/*
 * User.c
 *
 *  Created on: 14 may 2022
 *      Author: gonza
 */


#include "User.h"
#include "general.h"

static int idAI = 1000;
static int User_getUniqueId() {
	return idAI++;
}

/** \brief print the content of one element of User
*
* \param list User
* \return int
*
*/

void User_printOne(User s) {
	printf(
			"ID %d\nNombre: %s\nApellido: %s\nCodigo de vuelo: %s\nPrecio: %.2f\n",
			s.id, s.name, s.lastname, s.flycode, s.price);
	if (s.typeUser == 1) {
		puts("Clase: Economica\n");
	} else {
		if (s.typeUser == 2) {
			puts("Clase: Media\n");
		} else {
			puts("Clase: Alta\n");
		}
	}
	if (s.statusFlight == 2) {
		puts("Estado de vuelo: ACTIVO\n");
	} else {
		puts("Estado de vuelo: INACTIVO\n");
	}
}

/** \brief print the content of Users array
*
* \param list User*
* \param length int
* \return int
*
*/

int User_printUsers(User UsersList[], int size) {
	int r = -1;
	if (UsersList != NULL) {
		if (size > 0) {
			printf("%*s | %*s | %*s | %*s | %*s | %*s | %*s\n", -4, "ID", -MAX,
					"NOMBRE", -MAX, "APELLIDO", -MAX, "CODIGO", -MAX, "PRECIO",
					-MAX, "TIPO", -MAX, "ESTADO");
			printf("%*c | %*c | %*c | %*c | %*c | %*c | %*c\n", -4, '-', -MAX,
					'-', -MAX, '-', -MAX, '-', -MAX, '-', -MAX, '-', -MAX, '-');
			for (int i = 0; i < size; i++) {
				if (UsersList[i].isEmpty == OCCUPIED) {
					printf(
							"%-4d | %-10s | %-10s | %-10s | %-10.2f | %-10d | %-5d\n",
							UsersList[i].id, UsersList[i].name,
							UsersList[i].lastname,
							UsersList[i].flycode, UsersList[i].price,
							UsersList[i].typeUser,
							UsersList[i].statusFlight);
				}
			}
			r = 0;
		}
	}

	return r;
}

/** \brief To indicate that all position in the array are empty,
* this function put the flag (isEmpty) in TRUE in all
* position of the array
* \param list User* Pointer to array of User
* \param len int Array length
* \return int Return (-1) if Error [Invalid length or NULL pointer] - (0) if Ok
*
*/

int User_initializeUsers(User *UserList, int size) {
	int r = -1;
	int i;

	if (UserList != NULL && size > 0) {
		for (i = 0; i < size; i++) {
			UserList[i].isEmpty = FREE;
		}
	}
	return r;
}

/** \brief Search free space in array list, load the no-generic data of the User, gives him an ID and
 *  add User's data.
* \param list User* Pointer to array of User
* \param len int Array length
* \return int Return (-1) if Error [Invalid length or NULL pointer] - (0) if Ok
*
*/

int User_Membership(User UserList[], int size) {
	int r = -1;
	User auxUser;

	int index = User_SearchSpace(UserList, size, FREE);

	if (index != -1) {
		auxUser = User_LoadUser();
		auxUser.id = User_getUniqueId();
		if (addUser(UserList, size, auxUser.id,
				auxUser.name, auxUser.lastname, auxUser.price,
				auxUser.typeUser, auxUser.flycode) == 0) {
			r = 0;
		} else {
			printf("Error en la carga de datos");
		}

	}

	return r;
}

/** \brief add in a existing list of Users the values received as parameters
 * in the first empty position
 * \param list User*
 * \param len int
 * \param id int
 * \param name[] char
 * \param lastName[] char
 * \param price float
 * \param typeUser int
 * \param flycode[] char
 * \return int Return (-1) if Error [Invalid length or NULL pointer or without
 free space] - (0) if Ok*/

int addUser(User *list, int len, int id, char name[], char lastname[],
		float price, int typeUser, char flycode[]) {
	int r = -1;
	User aux;
	if (list != NULL
			&& len
					> 0&& id > 0 && name != NULL && lastname != NULL && price > 0 && typeUser > 0 && flycode != NULL) {
		int freeIndex = User_SearchSpace(list, len, FREE);
		strncpy(aux.name, name, sizeof(aux.name));
		strncpy(aux.lastname, lastname, sizeof(aux.lastname));
		strncpy(aux.flycode, flycode, sizeof(aux.flycode));
		aux.id = id;
		aux.price = price;
		aux.typeUser = typeUser;
		aux.isEmpty = OCCUPIED;
		aux.statusFlight = INPROCESS;
		list[freeIndex] = aux;
		r = 0;
	}

	return r;
}

/** \brief modifies one User of the array
 * \param list User*
 * \param len int
 * \return int Return (-1) if Error [Invalid length or NULL pointer or without
 free space] - (0) if Ok*/

int User_Edit(User UserList[], int size) {
	int r = -1;
	int indexToModify;
	int ID;
	User aux;

	if (UserList != NULL) {
		if (size > 0) {
			User_printUsers(UserList, size);
			if (utn_getNumero("Ingrese el ID a modificar:", "Hubo un error", 0,
					3, &ID) == 0) {
				indexToModify = User_SearchIndexPerId(UserList, size,
						ID);
				if (indexToModify == -1) {
					printMessage("No se encontro el ID en la lista.\n", 1);
					return r;
				} else {
					printMessage("El pasajero a modificar es el siguiente:\n",
							1);
					User_printOne(UserList[indexToModify]);
					aux = UserList[indexToModify];
					aux = User_ModificarUno(aux);
					if (confirmation(
							"¿Esta seguro que quiere modificar los datos?(1-Si/Otro numero-No)\n",
							"Ha habido un error en relacion al numero ingresado. Intentelo nuevamente.\n")
							== 1) {
						UserList[indexToModify] = aux;
						r = 0;
					}
				}
			}
		} else {
			r = -3;
		}
	} else {
		r = -2;
	}
	return r;
}

/** \brief Remove a User by Id (put isEmpty Flag in 1)
*
* \param list User*
* \param len int
* \param id int
* \return int Return (-1) if Error [Invalid length or NULL pointer or if can't
find a User] - (0) if Ok
*
*/
int User_Baja(User UserList[], int size) {
	int r = -1;
	int indexLow;
	int ID = 0;

	if (UserList != NULL) {
		if (size > 0) {
			User_printUsers(UserList, size);
			if (utn_getNumero("Ingrese el ID a dar de baja:\n",
					"Hubo un error\n", 0, 3, &ID) == 0) {
				indexLow = User_SearchIndexPerId(UserList, size, ID);
				if (indexLow == -1) {
					printMessage("No se encontro el ID en la lista.\n", 1);
					return r;
				} else {
					printMessage("El pasajero a dar de baja es el siguiente:\n",
							1);
					User_printOne(UserList[indexLow]);
					if (confirmation(
							"¿Esta seguro que quiere darlo de baja?(1-Si/Otro numero-No)\n",
							"Ha habido un error en relacion al numero ingresado. Intentelo nuevamente.\n")
							== 1) {
						UserList[indexLow].isEmpty = LOW;
						r = 0;
					}

				}
			}

		} else {
			r = -3;
		}
	} else {
		r = -2;
	}
	return r;
}


/** \brief gives options to modify to the user.
*
* \param list User*
* \param len int
* \param id int
* \return int Return (-1) if Error [Invalid length or NULL pointer or if can't
find a User] - (0) if Ok
*
*/
User User_ModificarUno(User s) {
	int opcion;
	do {
		if (utn_getNumero(
				"¿Que campo desea modificar? 1-Nombre\n2-Apellido\n3-Codigo de vuelo\n4-Tipo de pasajero\n5-Precio\n6-Salir\n",
				"Ha habido un error. Intentelo nuevamente.\n", 0, 3, &opcion)
				== 0) {
			switch (opcion) {
			case 1:
				getString(s.name, MAX_SIZE_CHAR, "Nombre:\n",
						"Ha habido un error\n", 3);
				break;
			case 2:
				getString(s.lastname, MAX_SIZE_CHAR, "Apellido:\n",
						"Ha habido un error\n", 3);
				break;
			case 3:
				getString(s.flycode, 10, "Codigo de vuelo:\n",
						"Ha habido un error.\n", 3);

				break;
			case 4:
				utn_getNumero("Tipo de pasajero: 1)Economico / 2)Clase alta\n",
						"Ha habido un error. Intentelo nuevamente.\n", 0, 3,
						&s.typeUser);
				break;
			case 5:
				utn_getNumeroFlotante("Precio:\n",
						"Ha habido un error. Intentelo nuevamente.\n", 0, 3,
						&s.price);
				break;
			case 6:
				printMessage("Saliendo...", 2);
				break;
			default:
				printMessage("Por favor, ingrese un numero entre 1 y 6.\n", 1);
			}
		}
	} while (opcion != 6);

	return s;
}

/** \brief Search an especific space in the array
*
* \param list User*
* \param len int
* \param id status (to search)
* \return int Return (-1) if Error [Invalid length or NULL pointer or if can't
find a User] - (0) if Ok
*
*/

int User_SearchSpace(User UserList[], int size, int status) {
	int r = -1;
	int i;

	if (UserList != NULL && size > 0) {
		for (i = 0; i <= size; i++) {
			if (UserList[i].isEmpty == status) {
				r = i;
				break;
			}
		}
	}
	return r;
}

/** \brief Search an especific flight status in the array
*
* \param list User*
* \param len int
* \param id statusFlight (to search)
* \return int Return (-1) if Error [Invalid length or NULL pointer or if can't
find a User] - (0) if Ok
*
*/

int User_SearchFlightStatus(User UserList[], int size,
		int statusFlight) {
	int r = -1;
	int i;

	if (UserList != NULL && size > 0) {
		for (i = 0; i < size; i++) {
			if (UserList[i].statusFlight == statusFlight) {
				r = i;
				break;
			}
		}
	}
	return r;
}

/** \brief Loads non-generic data to an User auxiliar and returns it
*
* \return int Return (-1) if Error [Invalid length or NULL pointer or if can't
find a User] - (0) if Ok
*
*/

User User_LoadUser() {
	User auxiliar;

	getString(auxiliar.name, MAX_SIZE_CHAR, "Nombre del pasajero:\n",
			"Error.\n", 3);
	getString(auxiliar.lastname, MAX_SIZE_CHAR, "Apellido:\n", "Error.\n", 3);
	getString(auxiliar.flycode, 10, "Codigo de vuelo:\n", "Error.\n", 3);
	utn_getNumeroFlotante("Precio:\n", "Error\n", 0, 3, &auxiliar.price);
	utn_getNumeroWithMax("Tipo de pasajero: (1-Economico 2-Medio 3-Alto)\n",
			"Error\n", 1, 3, 3, &auxiliar.typeUser);
	return auxiliar;

}

/** \brief find a User by Id en returns the index position in UsersList.
 *
 * \param list User*
 * \param len int
 * \param id int
 * \return Return User index position or (-1) if [Invalid length or
 NULL pointer received or User not found]
 *
 */
int User_SearchIndexPerId(User UserList[], int size, int ID) {
	int r = -1;
	int i;

	if (UserList != NULL && size > 0) {
		for (i = 0; i < size; i++) {
			if (UserList[i].id
					== ID&& UserList[i].isEmpty == OCCUPIED) {
				r = i;
				break;
			}
		}
	}

	return r;
}

/** \brief Sort the elements in the array of Users, the argument order
indicate UP or DOWN order
*
* \param list User*
* \param len int
* \param order int [1] indicate UP - [0] indicate DOWN
* \return int Return (-1) if Error [Invalid length or NULL pointer] - (0) if Ok
*
*/

int User_Sort(User UsersList[], int size, int order) {
	int r = -1;
	int i;
	int j;
	User aux;
	if (UsersList != NULL && size > 0) {
		switch (order) {
		case 1:
			for (i = 0; i < size - 1; i++) {
				for (j = i + 1; j < size; j++) {
					if (UsersList[i].isEmpty == OCCUPIED
							&& UsersList[j].isEmpty == OCCUPIED) {
						if (UsersList[i].typeUser
								> UsersList[j].typeUser) {
							if (strcmp(UsersList[i].lastname,
									UsersList[j].lastname) < 0) {
								aux = UsersList[i];
								UsersList[i] = UsersList[j];
								UsersList[j] = aux;
							} else {
								aux = UsersList[j];
								UsersList[j] = UsersList[i];
								UsersList[i] = aux;
							}
						} else {
							aux = UsersList[j];
							UsersList[j] = UsersList[i];
							UsersList[i] = aux;
						}
					}
				}
			}
			User_printUsers(UsersList, MAX_UserS);

			break;
		case 0:
			for (i = 0; i < size - 1; i++) {
				for (j = i + 1; j < size; j++) {
					if (UsersList[i].isEmpty == OCCUPIED
							&& UsersList[j].isEmpty == OCCUPIED) {
						if (UsersList[i].typeUser
								> UsersList[j].typeUser) {
							if (strcmp(UsersList[i].lastname,
									UsersList[j].lastname) > 0) {
								aux = UsersList[i];
								UsersList[i] = UsersList[j];
								UsersList[j] = aux;
							} else {
								aux = UsersList[j];
								UsersList[j] = UsersList[i];
								UsersList[i] = aux;
							}
						} else {
							aux = UsersList[j];
							UsersList[j] = UsersList[i];
							UsersList[i] = aux;
						}
					}
				}
			}
			User_printUsers(UsersList, MAX_UserS);

			break;
		default:
			printf("Por favor, ingrese 1 o 0.");
		}

		r = 0;
	}
	return r;
}

/** \brief Sort the elements in the array of Users, the argument order
indicate UP or DOWN order
*
* \param list User*
* \param len int
* \param order int [1] indicate UP - [0] indicate DOWN
* \return int Return (-1) if Error [Invalid length or NULL pointer] - (0) if Ok
*
*/

int User_AveragePrice(User UserList[], int size) {
	int r = -1;
	float priceAmount;
	int UsersAmount = 0;
	int highUserQuantity = 0;
	float average = 0;
	if (UserList != NULL && size > 0) {
		for (int i = 0; i <= size; i++) {
			if (UserList[i].isEmpty == OCCUPIED) {
				UsersAmount++;
				priceAmount = priceAmount + UserList[i].price;
				r = 0;
			}
		}
		average = priceAmount / (float) UsersAmount;
		if (average > 0) {
			for (int j = 0; j <= size; j++) {
				if (UserList[j].isEmpty == OCCUPIED) {
					if (UserList[j].price > average) {
						highUserQuantity++;
					}
				}
			}
			printf("\nEl total de precios es: %.2f\n", priceAmount);
			printf("\nEl promedio de precios es: %.2f\n", average);
			if (highUserQuantity > 0) {
				printf(
						"\nLa cantidad de pasajeros que superan el precio promedio es de: %d\n",
						highUserQuantity);
			} else {
				printf("\nNo ha habido pasajeros que superen el promedio.\n");
			}

		}

	}
	return r;
}

/** \brief Sort the elements in the array of Users, the argument order
indicate UP or DOWN order
*
* \param list User*
* \param len int
* \param order int [1] indicate UP - [0] indicate DOWN
* \return int Return (-1) if Error [Invalid length or NULL pointer] - (0) if Ok
*
*/

int User_SortByFlightcode(User UsersList[], int size, int order) {
	int r = -1;
	int i;
	int j;
	User aux;
	if (UsersList != NULL && size > 0) {
		for (i = 0; i < size - 1; i++) {
			for (j = i + 1; j < size; j++) {
				if (UsersList[i].isEmpty == OCCUPIED
						&& UsersList[j].isEmpty == OCCUPIED) {
					if (UsersList[i].statusFlight
							> UsersList[j].statusFlight) {
						if (strcmp(UsersList[i].flycode,
								UsersList[j].flycode) > 0) {
							aux = UsersList[i];
							UsersList[i] = UsersList[j];
							UsersList[j] = aux;
						} else {
							aux = UsersList[j];
							UsersList[j] = UsersList[i];
							UsersList[i] = aux;
						}
					} else {
						aux = UsersList[j];
						UsersList[j] = UsersList[i];
						UsersList[i] = aux;
					}
				}
			}
		}
		User_printUsers(UsersList, MAX_UserS);
		fflush(stdin);
		r = 0;
	}
	return r;
}
